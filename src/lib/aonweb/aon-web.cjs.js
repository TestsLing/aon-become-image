"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const U=require("web3"),d=require("web3-eth-accounts"),f={TYPE_TG:1,TYPE_FP:2};let l=class{constructor({rpc_url:e="https://dev.rpc.aonet.ai",type:s=f.TYPE_FP,server:n="https://dev.rpc.aonet.ai",password:i="",storeage_url:o="",timeout:r=3e3,force_aon:c=!0}={}){if(this.rpc_url=e,this.type=s,this.server=n,this.password=i,this.storeage_url=o,this.timeout=r,this.force_aon=c,this.type==f.TYPE_FP&&this.storeage_url=="")throw new Error("storeage_url must be set when type = TYPE_FP")}static get LoginTypes(){return f}};var w;(function(t){t.NUMBER="NUMBER_NUMBER",t.HEX="NUMBER_HEX",t.STR="NUMBER_STR",t.BIGINT="NUMBER_BIGINT"})(w||(w={}));var y;(function(t){t.HEX="BYTES_HEX",t.UINT8ARRAY="BYTES_UINT8ARRAY"})(y||(y={}));w.BIGINT,y.HEX;w.HEX,y.HEX;var v;(function(t){t.EARLIEST="earliest",t.LATEST="latest",t.PENDING="pending",t.SAFE="safe",t.FINALIZED="finalized"})(v||(v={}));var P;(function(t){t.chainstart="chainstart",t.frontier="frontier",t.homestead="homestead",t.dao="dao",t.tangerineWhistle="tangerineWhistle",t.spuriousDragon="spuriousDragon",t.byzantium="byzantium",t.constantinople="constantinople",t.petersburg="petersburg",t.istanbul="istanbul",t.muirGlacier="muirGlacier",t.berlin="berlin",t.london="london",t.altair="altair",t.arrowGlacier="arrowGlacier",t.grayGlacier="grayGlacier",t.bellatrix="bellatrix",t.merge="merge",t.capella="capella",t.shanghai="shanghai"})(P||(P={}));var E=function(t,e,s,n){function i(o){return o instanceof s?o:new s(function(r){r(o)})}return new(s||(s=Promise))(function(o,r){function c(h){try{p(n.next(h))}catch(m){r(m)}}function a(h){try{p(n.throw(h))}catch(m){r(m)}}function p(h){h.done?o(h.value):i(h.value).then(c,a)}p((n=n.apply(t,e||[])).next())})};const I=Symbol.for("web3/base-provider");class T{static isWeb3Provider(e){return e instanceof T||!!(e&&e[I])}get[I](){return!0}send(e,s){this.request(e).then(n=>{s(null,n)}).catch(n=>{s(n)})}sendAsync(e){return E(this,void 0,void 0,function*(){return this.request(e)})}asEIP1193Provider(){const e=Object.create(this),s=e.request;return e.request=function(i){return E(this,void 0,void 0,function*(){return(yield s(i)).result})},e.asEIP1193Provider=void 0,e}}class q{constructor(e=new Options){try{this.options=e}catch(s){throw s}}async setItem(e,s,n){try{let i=localStorage.getItem("fingerprint"),o={key:e+"_"+i,value:s},r=localStorage.getItem("token");r=r.replace(/^\"|\"$/g,"");let c={Authorization:"Bearer "+r},a=this.options.storeage_url+"/kvapi/v1/storage/set";const h=await(await fetch(a,{method:"POST",headers:c,body:JSON.stringify(o)})).json();h&&h.success?n(null):n(new Error(JSON.stringify(h)||""))}catch(i){n(i)}}async getItem(e,s){try{let n=localStorage.getItem("token");n=n.replace(/^\"|\"$/g,"");let i={Authorization:"Bearer "+n},o=localStorage.getItem("fingerprint");e=e+"_"+o;let r=this.options.storeage_url+"/kvapi/v1/storage/get?key="+e;const a=await(await fetch(r,{method:"GET",headers:i})).json();a&&a.success?s(null,a.value):s(new Error(JSON.stringify(a)||""),null)}catch(n){s(n,null)}}}let g;const D=new Uint8Array(16);function R(){if(!g&&(g=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!g))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return g(D)}const u=[];for(let t=0;t<256;++t)u.push((t+256).toString(16).slice(1));function x(t,e=0){return u[t[e+0]]+u[t[e+1]]+u[t[e+2]]+u[t[e+3]]+"-"+u[t[e+4]]+u[t[e+5]]+"-"+u[t[e+6]]+u[t[e+7]]+"-"+u[t[e+8]]+u[t[e+9]]+"-"+u[t[e+10]]+u[t[e+11]]+u[t[e+12]]+u[t[e+13]]+u[t[e+14]]+u[t[e+15]]}const Y=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),b={randomUUID:Y};function G(t,e,s){if(b.randomUUID&&!e&&!t)return b.randomUUID();t=t||{};const n=t.random||(t.rng||R)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,x(n)}class B extends T{constructor(e=new l){try{super(),this.options=e,this.isAON=!0,window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.initData&&(e.type=l.LoginTypes.TYPE_TG),e.type==l.LoginTypes.TYPE_TG?(this.webapp=window.Telegram.WebApp,this.storage=window.Telegram.WebApp.CloudStorage):e.type==l.LoginTypes.TYPE_FP&&(this.storage=new q(e)),this.keystore=null,this.account=null,this._nextId=0,this.provider=new U.Web3.providers.HttpProvider(e.rpc_url)}catch(s){throw s}}async _getPassword(){return await new Promise((s,n)=>{this.storage.getItem("aon_web_sdk_password",(i,o)=>{i&&n(i),s(o)})})}async check(e){try{let s={};if(e.type==l.LoginTypes.TYPE_TG)s={platform:"telegram",initData:this.webapp.initData};else if(e.type==l.LoginTypes.TYPE_FP){let r=localStorage.getItem("fingerprint");r||(r=await new Promise((c,a)=>{const p=G();c(p)}),localStorage.setItem("fingerprint",r)),s={platform:"fingerprint",visitorId:r}}let n=e.server+"/api/v1/user/check";const o=await(await fetch(n,{method:"POST",body:JSON.stringify(s)})).json();if(o.code==0&&o.data){const r=o.data.token;return r&&this.setAuth(r),o.data}return o}catch(s){throw s}}async setPassword(e){await new Promise((s,n)=>{this.storage.setItem("aon_web_sdk_password",e,i=>{i&&n(i),s()})})}generateRandomPassword(e){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+{}|:<>?-=[];',./";let n="";for(let i=0;i<e;i++){const o=Math.floor(Math.random()*s.length);n+=s[o]}return n}async getAuth(){return this.options.type==l.LoginTypes.TYPE_TG?await new Promise((s,n)=>{this.storage.getItem("token",(i,o)=>{i&&n(i),s(o)})}):localStorage.getItem("token")}async setAuth(e){this.options.type==l.LoginTypes.TYPE_TG?await new Promise((s,n)=>{this.storage.setItem("token",JSON.stringify(e),i=>{i&&n(i),s()})}):localStorage.setItem("token",e)}async createUserToServer(e,s){let n={keystore:JSON.stringify(e),signature:s},i=await this.getAuth();i=i.replace(/^\"|\"$/g,"");let o={Authorization:"Bearer "+i},r=this.options.server+"/api/v1/user/create";return await(await fetch(r,{method:"POST",headers:o,body:JSON.stringify(n)})).json()}async createUser(){let e=this.generateRandomPassword(20),s=d.create(),n=await d.encrypt(s.privateKey,e),o=d.sign(JSON.stringify(n),s.privateKey).signature,r=await this.createUserToServer(n,o);if(r.code==0)return await this.setPassword(e),{keystore:n,account:s};throw new Error(r.error||r.msg)}async loadKeystore(){try{let e=await this.check(this.options);if(e.code)throw new Error(e.msg||e.error);if(e.isNewUser){let n=await this.createUser();this.account=n.account,this.keystore=n.keystore;return}let s=await this._getPassword();this.keystore=JSON.parse(e.keystore),this.account=await d.decrypt(this.keystore,s)}catch(e){console.log("loadKeystore error",e)}}request(e){return console.log("request",e),e.method=="eth_accounts"||e.method=="eth_requestAccounts"?new Promise((s,n)=>{try{if(this.account){s([this.account.address]);return}s([])}catch(i){n(i)}}):e.method=="eth_sendTransaction"?(e.method="eth_signTransaction",new Promise((s,n)=>{let i=e.params&&e.params.length&&e.params[0];i.gasLimit||(i.gasLimit=5e5),this.provider.request({method:"eth_chainId"}).then(o=>{console.log("eth_chainId ",o);let r=100199;o.result&&(r=parseInt(o.result,16)),i.chainId||(i.chainId=r),i.v=27+i.chainId*2+8,this.provider.request({method:"eth_getTransactionCount",params:[this.account.address]}).then(c=>{console.log("eth_getTransactionCount ",c),i.nonce||(i.nonce=c.result),console.log("before signTransaction param",i),d.signTransaction(new d.Transaction(i),this.account.privateKey).then(a=>{if(console.log("signTransaction ",a),a&&a.rawTransaction&&a.rawTransaction.length){const p={method:"eth_sendRawTransaction",params:[a.rawTransaction],id:this._nextId++,jsonrpc:"2.0"};this.provider.request(p).then(h=>{console.log("eth_sendRawTransaction ",h),s(h)}).catch(h=>{console.log("eth_sendRawTransaction error",h),n(h)})}else n(new Error("signTransaction error"))}).catch(a=>{console.log("signTransaction error",a),n(a)})}).catch(c=>{console.log("eth_getTransactionCount error",c),n(c)})}).catch(o=>{console.log("eth_chainId error",o),n(o)})})):this.provider.request(e)}async send(e,s){console.log("send",e,s);const n={method:e,params:s,id:this._nextId++,jsonrpc:"2.0"};return this.request(n)}}async function _(t=new l){console.log("detectEthereumProvider in");let e=!1;return await new Promise(async(n,i)=>{if(window.ethereum){if(t.force_aon&&!window.ethereum.isAON){let r=await o(t);n(r)}n(window.ethereum)}else{let r=await o(t);n(r)}async function o(r){if(console.log("createProvider in"),e)return;e=!0;const c=new B(r);return await c.loadKeystore(),window.ethereum=c,console.log("createProvider instance",c),c}})}class A{constructor(e=new l){this.options=e}async login(){return(await _(this.options)).request({method:"eth_accounts"})}}const L=1,S=2,W={1:"/api",2:"/jwt"};class N{constructor(e){if(!(e&&e.auth&&e.auth.length))throw new Error("options.auth is not found");this.auth=e.auth,this.options=e,this.init()}init(){let e="/v1";this.options&&this.options.api_version&&this.options.api_version.length&&(e=this.options.api_version),this.auth_type=this.parseAuthType(this.auth),this.path=W[this.auth_type]+e}parseAuthType(e){const s=this.decodeBase64(e);return console.log("parseAuthType",s),s.indexOf("JWT")>-1?S:L}decodeBase64(e){return typeof window<"u"&&typeof window.atob=="function"?window.atob(e):Buffer.from(e,"base64").toString("utf-8")}async prediction(e,s){try{let n="https://api.aonet.ai";this.options&&this.options.host&&this.options.host.length&&(n=this.options.host);const i=n+this.path+e;let o={apikey:this.auth};if(this.auth_type==S&&(o={Authorization:"Bearer "+this.auth}),this.options&&this.options.headers)for(const a in this.options.headers)a!="apikey"&&a!="Authorization"&&(o[a]=this.options.headers[a]);const r=await fetch(i,{method:"POST",headers:o,body:JSON.stringify(s)});return r?await r.json():{task:{is_success:!1,task_error:"network error",exec_code:"5000"}}}catch(n){console.error("Error:",n)}}}(function(t,e){typeof define=="function"&&define.amd?define(["web3","web3-eth-accounts"],e):typeof module=="object"&&module.exports?module.exports=e(require("web3"),require("web3-eth-accounts")):t.aonweb=e(t.Web3,t.Web3EthAccounts)})(typeof self<"u"?self:void 0,function(t,e){return{Options:l,User:A,AI:N,detectEthereumProvider:_}});exports.AI=N;exports.Options=l;exports.User=A;exports.detectEthereumProvider=_;
